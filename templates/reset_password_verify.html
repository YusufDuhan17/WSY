{% extends "base.html" %}

{% block title %}Doğrulama - Şifre Yöneticisi{% endblock %}

{% block head_extra %}
<style>
    .verification-form {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 30px;
        margin: 20px 0;
        border: 2px solid rgba(255, 255, 255, 0.2);
    }
    .security-question-box {
        background: rgba(0, 0, 0, 0.3);
        padding: 20px;
        border-radius: 10px;
        margin: 15px 0;
        border-left: 4px solid var(--primary-color);
    }
    .recovery-key-input {
        font-family: 'Courier New', monospace;
        font-size: 1.2em;
        letter-spacing: 2px;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block content %}
    <header class="content-header">
        <h1>Doğrulama</h1>
        <p>Hesap: <strong>{{ user.username }}</strong></p>
    </header>
    
    <form method="POST" action="{{ url_for('reset_password_verify') }}" 
          enctype="multipart/form-data" class="content-form" style="max-width: 700px;">
        
        {% if method == 'security_questions' %}
        <div class="verification-form">
            <h2 style="color: white; margin-bottom: 20px;">
                <i class="fas fa-question-circle"></i> Güvenlik Soruları
            </h2>
            <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 25px;">
                Lütfen kayıt sırasında belirlediğiniz 3 güvenlik sorusunun cevaplarını girin.
                <strong>Tüm soruları doğru cevaplamanız gerekmektedir.</strong>
            </p>
            
            {% for sq in security_questions %}
            <div class="security-question-box">
                <label style="color: white; font-weight: bold; display: block; margin-bottom: 10px;">
                    Soru {{ loop.index }}:
                </label>
                <p style="color: rgba(255, 255, 255, 0.9); margin: 0 0 15px 0; font-style: italic;">
                    {{ sq.question }}
                </p>
                <input type="text" name="answer_{{ loop.index }}" 
                       placeholder="Cevabınızı girin" required
                       style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); color: white;">
            </div>
            {% endfor %}
        </div>
        
        {% elif method == 'recovery_key' %}
        <div class="verification-form">
            <h2 style="color: white; margin-bottom: 20px;">
                <i class="fas fa-key"></i> Kurtarma Anahtarı
            </h2>
            <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 25px;">
                Kayıt sırasında aldığınız kurtarma anahtarınızı girin:
            </p>
            
            <label for="recovery_key" style="color: white; display: block; margin-bottom: 10px;">
                Kurtarma Anahtarı:
            </label>
            <input type="text" id="recovery_key" name="recovery_key" 
                   placeholder="XXXX-XXXX-XXXX-XXXX" required
                   class="recovery-key-input"
                   maxlength="19"
                   style="width: 100%; padding: 15px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); color: white; text-align: center;"
                   oninput="formatRecoveryKey(this)"
                   onkeydown="handleRecoveryKeyInput(event)">
            
            <script>
                function formatRecoveryKey(input) {
                    // Mevcut değeri al
                    let value = input.value;
                    
                    // Sadece harf, rakam ve tire bırak, büyük harfe çevir
                    value = value.toUpperCase().replace(/[^A-Z0-9-]/g, '');
                    
                    // Tire'leri kaldır
                    value = value.replace(/-/g, '');
                    
                    // Her 4 karakterden sonra tire ekle
                    let formatted = '';
                    for (let i = 0; i < value.length; i++) {
                        if (i > 0 && i % 4 === 0) {
                            formatted += '-';
                        }
                        formatted += value[i];
                    }
                    
                    // Maksimum 19 karakter (XXXX-XXXX-XXXX-XXXX)
                    if (formatted.length > 19) {
                        formatted = formatted.substring(0, 19);
                    }
                    
                    input.value = formatted;
                }
                
                function handleRecoveryKeyInput(event) {
                    // Geri tuşuna basıldığında veya silme işlemi yapıldığında formatlamayı engelleme
                    if (event.key === 'Backspace' || event.key === 'Delete') {
                        return true;
                    }
                }
            </script>
        </div>
        
        {% elif method == 'key_file' %}
        <div class="verification-form">
            <h2 style="color: white; margin-bottom: 20px;">
                <i class="fas fa-file-alt"></i> Anahtar Dosyası
            </h2>
            <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 25px;">
                Kayıt sırasında indirdiğiniz key file'ı yükleyin:
            </p>
            
            <label for="key_file" style="color: white; display: block; margin-bottom: 10px;">
                Key File Seçin:
            </label>
            <input type="file" id="key_file" name="key_file" 
                   accept=".json,.txt" required
                   style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); color: white;">
            <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.9em; margin-top: 10px;">
                <i class="fas fa-info-circle"></i> Key file genellikle .json veya .txt formatındadır.
            </p>
        </div>
        {% endif %}

        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button type="submit" class="button primary-button" style="flex: 1;">
                <i class="fas fa-check"></i> Doğrula
            </button>
            <a href="{{ url_for('reset_password_method') }}" class="button secondary-button">
                <i class="fas fa-arrow-left"></i> Geri
            </a>
        </div>
    </form>
{% endblock %}

