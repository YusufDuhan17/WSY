{% extends "base.html" %}

{% block title %}Şifreyi Güncelle - Şifre Yöneticisi{% endblock %}

{% block content %}
    <header class="content-header">
        <h1>Şifreyi Güncelle</h1>
        <a href="{{ url_for('dashboard') }}" class="button">Geri Dön</a>
    </header>
    
    <form method="POST" action="{{ url_for('update_password', password_id=entry.id) }}" class="content-form content-form-two-columns">
        <div class="form-column-left">
            <label for="site">Site/Uygulama:</label>
            <input type="text" id="site" name="site" value="{{ entry.site }}" required>

            <label for="username">Kullanıcı Adı:</label>
            <input type="text" id="username" name="username" value="{{ entry.username }}" required>
        </div>
        <div class="form-column-right">
            <label for="password">Şifre:</label>
            <div style="display: flex; gap: 10px;">
                <input type="password" id="password" name="password" value="{{ decrypted_pwd }}" required style="flex: 1;">
                <button type="button" onclick="openPasswordGeneratorForUpdate()" class="button secondary-button" style="white-space: nowrap;">
                    <i class="fas fa-magic"></i> Oluştur
                </button>
            </div>
            <input type="hidden" id="strength-text-update" name="strength-text-update" value="{{ entry.strength }}">
            
            <div class="strength-feedback">
                <label id="strength-label-update">Şifre Gücü: Bilinmiyor</label>
                <progress id="strength-progressbar-update" value="0" max="100"></progress>
                <div class="feedback-content">
                    <h4>Şifre Gücü İpuçları:</h4>
                    <ul id="strength-feedback-list-update">
                        </ul>
                </div>
            </div>
            

            <label for="category">Kategori:</label>
            <div class="form-row">
                <select id="category" name="category" required>
                    {% for cat in categories %}
                        <option value="{{ cat }}" {% if cat == entry.category %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>
                <button id="add-new-category-btn" type="button" class="button accent-button">Yeni Kategori Ekle</button>
            </div>

            <div id="new-category-input-area" style="display: none;" class="form-row new-category-controls">
                <input type="text" id="new-category-name" placeholder="Yeni kategori adı..." />
                <button type="button" id="save-new-category-btn" class="button primary-button">Ekle</button>
                <button type="button" id="cancel-new-category-btn" class="button secondary-button">İptal</button>
            </div>
        </div>
        <button type="submit" class="button primary-button form-submit-button">Güncelle</button>
    </form>

    <!-- Şifre Oluşturucu Modal (Update Password için) -->
    <div id="password-generator-modal-update" class="password-generator-modal" style="display: none;">
        <div class="password-generator-content" style="background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%); padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);">
            <h2 style="color: white; margin-bottom: 20px;"><i class="fas fa-magic"></i> Şifre Oluşturucu</h2>
            <div style="margin-bottom: 15px;">
                <label style="color: white; display: block; margin-bottom: 5px;">Uzunluk:</label>
                <input type="range" id="pwd-length-update" min="8" max="50" value="16" style="width: 100%;" oninput="document.getElementById('pwd-length-display-update').textContent = this.value">
                <span id="pwd-length-display-update" style="color: white;">16</span>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="color: white; display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="checkbox" id="pwd-uppercase-update" checked>
                    <span>Büyük Harf (A-Z)</span>
                </label>
                <label style="color: white; display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="checkbox" id="pwd-lowercase-update" checked>
                    <span>Küçük Harf (a-z)</span>
                </label>
                <label style="color: white; display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="checkbox" id="pwd-numbers-update" checked>
                    <span>Sayılar (0-9)</span>
                </label>
                <label style="color: white; display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="checkbox" id="pwd-symbols-update" checked>
                    <span>Özel Karakterler (!@#$...)</span>
                </label>
            </div>
            <div style="margin-bottom: 15px;">
                <input type="text" id="generated-password-update" readonly style="width: 100%; padding: 10px; border-radius: 5px; font-size: 1.2em; text-align: center;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="generatePasswordForUpdate()" class="button primary-button" style="flex: 1;">
                    <i class="fas fa-sync"></i> Oluştur
                </button>
                <button onclick="useGeneratedPasswordForUpdate()" class="button secondary-button">
                    <i class="fas fa-check"></i> Kullan
                </button>
                <button onclick="closePasswordGeneratorForUpdate()" class="button delete-button">
                    <i class="fas fa-times"></i> Kapat
                </button>
            </div>
        </div>
    </div>

    <script>
        function openPasswordGeneratorForUpdate() {
            document.getElementById('password-generator-modal-update').style.display = 'flex';
            generatePasswordForUpdate();
        }

        function closePasswordGeneratorForUpdate() {
            document.getElementById('password-generator-modal-update').style.display = 'none';
        }

        function generatePasswordForUpdate() {
            const length = parseInt(document.getElementById('pwd-length-update').value);
            const includeUppercase = document.getElementById('pwd-uppercase-update').checked;
            const includeLowercase = document.getElementById('pwd-lowercase-update').checked;
            const includeNumbers = document.getElementById('pwd-numbers-update').checked;
            const includeSymbols = document.getElementById('pwd-symbols-update').checked;

            fetch('{{ url_for("generate_password") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    length: length,
                    include_uppercase: includeUppercase,
                    include_lowercase: includeLowercase,
                    include_numbers: includeNumbers,
                    include_symbols: includeSymbols
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    document.getElementById('generated-password-update').value = data.password;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Şifre oluşturulurken hata oluştu.');
            });
        }

        function useGeneratedPasswordForUpdate() {
            const generatedPassword = document.getElementById('generated-password-update').value;
            if (generatedPassword) {
                document.getElementById('password').value = generatedPassword;
                document.getElementById('password').dispatchEvent(new Event('input'));
                closePasswordGeneratorForUpdate();
            }
        }

        document.getElementById('password-generator-modal-update').addEventListener('click', function(e) {
            if (e.target === this) {
                closePasswordGeneratorForUpdate();
            }
        });
    </script>
{% endblock %}