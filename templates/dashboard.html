{% extends "base.html" %}

{% block title %}Şifrelerim - Şifre Yöneticisi{% endblock %}

{% block head_extra %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .stat-card h3 {
        font-size: 2.5em;
        margin: 0;
        color: var(--text-color-light);
    }
    .stat-card p {
        margin: 10px 0 0 0;
        color: rgba(255, 255, 255, 0.9);
    }
    .warning-banner {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        color: white;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
    }
    .search-filter-bar {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .search-box {
        flex: 1;
        min-width: 250px;
        position: relative;
    }
    .search-box input {
        width: 100%;
        padding: 12px 45px 12px 15px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        color: white;
        font-size: 1em;
    }
    .search-box input::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }
    .search-box i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(255, 255, 255, 0.7);
    }
    .filter-select {
        padding: 12px 15px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        color: white;
        font-size: 1em;
        cursor: pointer;
    }
    .filter-select option {
        background: #2a2a72;
        color: white;
    }
    .tools-bar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .password-generator-modal {
        display: none;
        position: fixed;
        z-index: 3000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        align-items: center;
        justify-content: center;
    }
    .password-generator-modal.show {
        display: flex !important;
    }
    .password-generator-content {
        background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
        padding: 30px;
        border-radius: 20px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
</style>
{% endblock %}

{% block content %}
    <header class="content-header">
        <h1>Şifrelerin</h1>
        <p>Hoş Geldin, {{ user.username }}!</p>
    </header>

    <div class="info-box" style="background: rgba(33, 150, 243, 0.2); border-left: 4px solid #2196F3; padding: 15px; border-radius: 10px; margin-bottom: 20px; color: white;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-info-circle" style="font-size: 1.2em;"></i>
            <div>
                <strong>Bilgi:</strong> Şifrenizi unuttuysanız, <a href="{{ url_for('forgot_password') }}" style="color: #f1c40f; text-decoration: underline;">Şifremi Unuttum</a> sayfasından kurtarma yöntemlerinizle şifrenizi sıfırlayabilirsiniz. 
                Şifrenizi değiştirmek için <a href="{{ url_for('change_password') }}" style="color: #f1c40f; text-decoration: underline;">Şifre Değiştir</a> sayfasını kullanın.
            </div>
        </div>
    </div>

    {% if stats %}
    <div class="stats-grid">
        <div class="stat-card">
            <h3>{{ stats.total_passwords }}</h3>
            <p><i class="fas fa-key"></i> Toplam Şifre</p>
        </div>
        <div class="stat-card">
            <h3>{{ stats.total_categories }}</h3>
            <p><i class="fas fa-folder"></i> Kategori</p>
        </div>
        <div class="stat-card">
            <h3>{{ stats.strong_passwords }}</h3>
            <p><i class="fas fa-shield-alt"></i> Güçlü Şifre</p>
        </div>
        <div class="stat-card">
            <h3>{{ stats.weak_passwords }}</h3>
            <p><i class="fas fa-exclamation-circle"></i> Zayıf Şifre</p>
        </div>
    </div>
    {% endif %}

    <div class="content-actions">
        <a href="{{ url_for('add_password') }}" class="button primary-button">
            <i class="fas fa-plus-circle"></i> Yeni Şifre Ekle
        </a>
        <button onclick="openPasswordGenerator()" class="button secondary-button">
            <i class="fas fa-magic"></i> Şifre Oluştur
        </button>
        <a href="{{ url_for('export_passwords') }}" class="button secondary-button">
            <i class="fas fa-download"></i> Dışa Aktar
        </a>
        <label for="import-file" class="button secondary-button" style="cursor: pointer;">
            <i class="fas fa-upload"></i> İçe Aktar
            <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importPasswords(this)">
        </label>
    </div>

    <div class="search-filter-bar">
        <div class="search-box">
            <input type="text" id="search-input" placeholder="Şifre ara..." oninput="filterPasswords()">
            <i class="fas fa-search"></i>
        </div>
        <select class="filter-select" id="category-filter" onchange="filterPasswords()">
            <option value="">Tüm Kategoriler</option>
            {% for category in categories %}
            <option value="{{ category }}">{{ category }}</option>
            {% endfor %}
        </select>
        <select class="filter-select" id="strength-filter" onchange="filterPasswords()">
            <option value="">Tüm Güç Seviyeleri</option>
            <option value="Çok Güçlü">Çok Güçlü</option>
            <option value="Güçlü">Güçlü</option>
            <option value="Orta">Orta</option>
            <option value="Zayıf">Zayıf</option>
        </select>
    </div>

    <div class="password-grid" id="password-grid">
        {% for pwd in passwords %}
        <div class="password-card" data-site="{{ pwd.site|lower }}" data-category="{{ pwd.category }}" data-strength="{{ pwd.strength }}">
            <div class="card-header">
                <h3>{{ pwd.site }}</h3>
                <span class="strength-indicator strength-{{ pwd.strength.split(' ')[0]|lower }}">{{ pwd.strength }}</span>
            </div>
            <div class="card-body">
                <p><strong>Kullanıcı Adı:</strong> <span class="username-display">{{ pwd.username }}</span></p>
                <p><strong>Şifre:</strong> <span id="password_display_{{ pwd.id }}" data-original-password="{{ pwd.password }}"></span></p>
                <p><strong>Kategori:</strong> <span class="category-tag category-{{ pwd.category.replace(' ', '-').lower() }}">{{ pwd.category }}</span></p>
            </div>
            <div class="card-actions">
                <button class="button show-hide-btn" onclick="togglePasswordVisibility(this, {{ pwd.id }})">Göster</button>
                <button class="button copy-password-btn" onclick="copyToClipboard(this)">Kopyala</button> 
                <a href="{{ url_for('update_password', password_id=pwd.id) }}" class="button secondary-button">Düzenle</a>
                <form action="{{ url_for('delete_password', password_id=pwd.id) }}" method="post" style="display:inline-block;">
                    <button type="submit" class="button delete-button" onclick="return confirm('Bu şifreyi silmek istediğinizden emin misiniz?');">Sil</button>
                </form>
            </div>
        </div>
        {% else %}
        <p class="no-passwords">Henüz kaydedilmiş şifreniz yok.</p>
        {% endfor %}
    </div>

    <!-- Şifre Oluşturucu Modal -->
    <div id="password-generator-modal" class="password-generator-modal">
        <div class="password-generator-content">
            <h2 style="color: white; margin-bottom: 20px;"><i class="fas fa-magic"></i> Şifre Oluşturucu</h2>
            <div style="margin-bottom: 15px;">
                <label style="color: white; display: block; margin-bottom: 5px;">Uzunluk:</label>
                <input type="range" id="pwd-length" min="8" max="50" value="16" style="width: 100%;" oninput="document.getElementById('pwd-length-display').textContent = this.value">
                <span id="pwd-length-display" style="color: white;">16</span>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="color: white; display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="checkbox" id="pwd-uppercase" checked>
                    <span>Büyük Harf (A-Z)</span>
                </label>
                <label style="color: white; display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="checkbox" id="pwd-lowercase" checked>
                    <span>Küçük Harf (a-z)</span>
                </label>
                <label style="color: white; display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="checkbox" id="pwd-numbers" checked>
                    <span>Sayılar (0-9)</span>
                </label>
                <label style="color: white; display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="checkbox" id="pwd-symbols" checked>
                    <span>Özel Karakterler (!@#$...)</span>
                </label>
            </div>
            <div style="margin-bottom: 15px;">
                <input type="text" id="generated-password" readonly style="width: 100%; padding: 10px; border-radius: 5px; font-size: 1.2em; text-align: center;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="generatePassword()" class="button primary-button" style="flex: 1;">
                    <i class="fas fa-sync"></i> Oluştur
                </button>
                <button onclick="copyGeneratedPassword()" class="button secondary-button">
                    <i class="fas fa-copy"></i> Kopyala
                </button>
                <button onclick="closePasswordGenerator()" class="button delete-button">
                    <i class="fas fa-times"></i> Kapat
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block body_extra %}
<script>
    function filterPasswords() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const categoryFilter = document.getElementById('category-filter').value;
        const strengthFilter = document.getElementById('strength-filter').value;
        const cards = document.querySelectorAll('.password-card');
        
        cards.forEach(card => {
            const site = card.dataset.site || '';
            const category = card.dataset.category || '';
            const strength = card.dataset.strength || '';
            
            const matchesSearch = site.includes(searchTerm);
            const matchesCategory = !categoryFilter || category === categoryFilter;
            const matchesStrength = !strengthFilter || strength === strengthFilter;
            
            if (matchesSearch && matchesCategory && matchesStrength) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    function openPasswordGenerator() {
        document.getElementById('password-generator-modal').classList.add('show');
        generatePassword();
    }

    function closePasswordGenerator() {
        document.getElementById('password-generator-modal').classList.remove('show');
    }

    function generatePassword() {
        const length = parseInt(document.getElementById('pwd-length').value);
        const includeUppercase = document.getElementById('pwd-uppercase').checked;
        const includeLowercase = document.getElementById('pwd-lowercase').checked;
        const includeNumbers = document.getElementById('pwd-numbers').checked;
        const includeSymbols = document.getElementById('pwd-symbols').checked;

        fetch('{{ url_for("generate_password") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                length: length,
                include_uppercase: includeUppercase,
                include_lowercase: includeLowercase,
                include_numbers: includeNumbers,
                include_symbols: includeSymbols
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                document.getElementById('generated-password').value = data.password;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Şifre oluşturulurken hata oluştu.');
        });
    }

    function copyGeneratedPassword() {
        const passwordField = document.getElementById('generated-password');
        passwordField.select();
        document.execCommand('copy');
        alert('Şifre kopyalandı!');
    }

    function importPasswords(input) {
        if (!input.files || !input.files[0]) return;
        
        const formData = new FormData();
        formData.append('file', input.files[0]);
        
        fetch('{{ url_for("import_passwords") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('İçe aktarma sırasında hata oluştu.');
        });
    }

    // Modal dışına tıklayınca kapat
    document.getElementById('password-generator-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePasswordGenerator();
        }
    });
</script>
{% endblock %}
